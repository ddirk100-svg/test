<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ keyword }} - ë‰´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='common.js') }}"></script>
</head>
<body>
    <div class="container">
        <div class="results-header">
            <a href="/" class="back-button">â† í™ˆìœ¼ë¡œ</a>
            <h1 class="results-title">"{{ keyword }}" ê´€ë ¨ ë‰´ìŠ¤</h1>
            <p class="results-subtitle">ì´ {{ items|length }}ê°œì˜ ë‰´ìŠ¤ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤</p>
        </div>
        
        {% if error %}
        <div class="error-message">
            {{ error }}
        </div>
        {% endif %}
        
        {% if items %}
        <div class="news-grid">
            {% for item in items %}
            <div class="news-card">
                <div class="card-header">
                    <h2 class="news-title">{{ item.title | safe }}</h2>
                    <button 
                        onclick="toggleFavorite(this, '{{ item.title | safe | replace("'", "\\'") }}', '{{ item.description | safe | replace("'", "\\'") }}', '{{ item.summary | replace("'", "\\'") }}', '{{ item.link }}')" 
                        class="favorite-button"
                        data-link="{{ item.link }}"
                        title="ì¦ê²¨ì°¾ê¸°"
                    >
                        <span class="star-icon">â˜†</span>
                    </button>
                </div>
                
                <div class="card-body">
                    <div class="section ai-summary">
                        <span class="label">ğŸ¤– AI ìš”ì•½</span>
                        <p class="summary-text">{{ item.summary }}</p>
                    </div>
                    
                    <div class="section">
                        <span class="label">ğŸ“„ ì›ë¬¸ ë¯¸ë¦¬ë³´ê¸°</span>
                        <p class="news-description">{{ item.description | safe }}</p>
                    </div>
                    
                    <div class="card-footer">
                        <a href="{{ item.link }}" target="_blank" class="read-more-button">
                            ğŸ“° ê¸°ì‚¬ ë³´ê¸°
                        </a>
                        <button onclick="shareArticle('{{ item.link }}', '{{ item.title | safe | replace("'", "\\'") }}')" class="share-button">
                            ğŸ”— ê³µìœ 
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
            <p>ğŸ˜• ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <a href="/" class="search-button">ë‹¤ì‹œ ê²€ìƒ‰í•˜ê¸°</a>
        </div>
        {% endif %}
        
        <div class="results-footer">
            <a href="/" class="back-home-button">ğŸ  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>
    
    <footer>
        <p>Powered by Naver News API & OpenAI GPT-4o-mini</p>
    </footer>
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦ê²¨ì°¾ê¸° ìƒíƒœ í™•ì¸
        async function checkFavoriteStatus() {
            
            try {
                const response = await fetch('/favorites');
                const text = await response.text();
                
                // HTML íŒŒì‹±í•˜ì—¬ ì¦ê²¨ì°¾ê¸° ë§í¬ ì¶”ì¶œ
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                
                // ëª¨ë“  ì¦ê²¨ì°¾ê¸° ë§í¬ë¥¼ Setìœ¼ë¡œ ì €ì¥
                const favoriteLinks = new Set();
                doc.querySelectorAll('.news-card').forEach(card => {
                    const link = card.querySelector('.read-more-button')?.href;
                    if (link) favoriteLinks.add(link);
                });
                
                // í˜„ì¬ í˜ì´ì§€ì˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.favorite-button').forEach(button => {
                    const link = button.getAttribute('data-link');
                    if (favoriteLinks.has(link)) {
                        const starIcon = button.querySelector('.star-icon');
                        if (starIcon) {
                            starIcon.textContent = 'â­';
                            starIcon.classList.add('favorited');
                        }
                    }
                });
            } catch (error) {
                console.error('ì¦ê²¨ì°¾ê¸° ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì¦ê²¨ì°¾ê¸° í† ê¸€ (ì¶”ê°€/ì œê±°)
        async function toggleFavorite(button, title, description, summary, link) {
            const starIcon = button.querySelector('.star-icon');
            const isFavorited = starIcon.classList.contains('favorited');
            
            // HTML ì—”í‹°í‹° ë””ì½”ë”©
            const parser = new DOMParser();
            const decodedTitle = parser.parseFromString(title, 'text/html').body.textContent;
            const decodedDescription = parser.parseFromString(description, 'text/html').body.textContent;
            
            try {
                if (isFavorited) {
                    // ì¦ê²¨ì°¾ê¸° ì œê±°
                    const response = await fetch('/api/favorites/remove', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            link: link
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        starIcon.textContent = 'â˜†';
                        starIcon.classList.remove('favorited');
                        alert('ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert(data.message || 'ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    // ì¦ê²¨ì°¾ê¸° ì¶”ê°€
                    const response = await fetch('/api/favorites/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: decodedTitle,
                            description: decodedDescription,
                            summary: summary,
                            link: link
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        starIcon.textContent = 'â­';
                        starIcon.classList.add('favorited');
                        alert('â­ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        alert(data.message || 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦ê²¨ì°¾ê¸° ìƒíƒœ í™•ì¸
        window.addEventListener('DOMContentLoaded', checkFavoriteStatus);
    </script>
</body>
</html>

